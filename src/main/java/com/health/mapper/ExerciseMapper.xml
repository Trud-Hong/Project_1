<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.exercise">

    <resultMap id="exerciseRecordResultMap" type="com.health.dto.ExerciseDTO">
        <result property="exercise_record_id" column="RECORD_ID" javaType="int" jdbcType="NUMERIC"/>
        <result property="member_no" column="MEMBER_NO" javaType="int" jdbcType="NUMERIC"/>
        <result property="exercise_type_id" column="EX_ID" javaType="int" jdbcType="NUMERIC"/>
        <result property="exercise_date" column="EXERCISE_DATE" javaType="string" jdbcType="VARCHAR"/>
        <result property="duration_minutes" column="DURATION" javaType="int" jdbcType="NUMERIC"/>
        <result property="reg_date" column="EX_DATE" javaType="java.sql.Date" jdbcType="DATE"/>
        <result property="name" column="NAME" javaType="string" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 최대 운동 기록 ID 조회 -->
    <select id="maxNum" resultType="int">
        SELECT NVL(MAX(record_id), 0) FROM exercise_record
    </select>
    
    <!-- 운동 기록 추가 - 기본 필드만 -->
    <insert id="insertData" parameterType="com.health.dto.ExerciseDTO">
        INSERT INTO exercise_record (
            record_id, member_no, ex_id, ex_date, duration
        )
        VALUES (
            (SELECT NVL(MAX(record_id), 0) + 1 FROM exercise_record),
            #{member_no}, 
            #{exercise_type_id}, 
            TO_DATE(#{exercise_date}, 'YYYY-MM-DD'), 
            #{duration_minutes}
        )
    </insert>

    <!-- 특정 운동 기록 조회 (ID로) -->
    <select id="getReadData" parameterType="int" resultMap="exerciseRecordResultMap">
        SELECT er.record_id as RECORD_ID, 
               er.member_no as MEMBER_NO, 
               er.ex_id as EX_ID, 
               TO_CHAR(er.ex_date, 'YYYY-MM-DD') as EXERCISE_DATE,
               er.duration as DURATION, 
               er.ex_date as EX_DATE, 
               NVL(e.name, 'Unknown') as NAME
        FROM exercise_record er 
        LEFT JOIN exercise e ON er.ex_id = e.ex_id
        WHERE er.record_id = #{exercise_record_id}
    </select>
    
    <!-- 특정 회원의 특정 날짜 운동 기록 조회 (메인페이지용) - 날짜 비교 수정 -->
   <select id="getTodayExercise" parameterType="map" resultType="com.health.dto.ExerciseDTO">
    SELECT er.record_id as exercise_record_id, 
           er.member_no, 
           er.ex_id as exercise_type_id,
           TO_CHAR(er.ex_date, 'YYYY-MM-DD') as exercise_date,
           er.duration as duration_minutes, 
           er.ex_date as reg_date,
           -- ex_id에 따라 운동명 하드코딩
           CASE er.ex_id
               WHEN 1 THEN '걷기(빠른속도 6.5KM/H)'
               WHEN 2 THEN '조깅 8km/h'  
               WHEN 3 THEN '자전거 타기(중간 속도 19km/h)'
               WHEN 4 THEN '수영(자유형)'
               WHEN 5 THEN '줄넘기'
               WHEN 6 THEN '계단 오르기'
               WHEN 7 THEN '에어로빅(고강도)'
               WHEN 8 THEN '복싱'
               WHEN 9 THEN '하이킹'
               WHEN 10 THEN '러닝'
               WHEN 11 THEN '스쿼트'
               WHEN 12 THEN '데드리프트'
               WHEN 13 THEN '벤치프레스'
               WHEN 14 THEN '풀업/턱걸이'
               WHEN 15 THEN '밀리터리 프레스'
               WHEN 16 THEN '바벨 로우'
               WHEN 17 THEN '런지'
               WHEN 18 THEN '랫풀다운'
               WHEN 19 THEN '레그 프레스'
               WHEN 20 THEN '케이블 크로스오버/플라이'
               WHEN 21 THEN '빠르게 걷기(6.5km/h)'
               WHEN 22 THEN '요가'
               WHEN 23 THEN '스탭박스 운동'
               WHEN 24 THEN '실내 클라이밍'
               WHEN 25 THEN '배드민턴'
               WHEN 26 THEN '훌랑후프 돌리기'
               WHEN 27 THEN '스피닝'
               WHEN 28 THEN '스탠딩 코어운동'
               WHEN 29 THEN '밴드 운동'
               WHEN 30 THEN '트램펄린 점프 운동'
               ELSE 'Unknown'
           END as name,
           -- 칼로리 계산
           CASE 
               WHEN er.ex_id BETWEEN 1 AND 10 THEN er.duration * 8  -- 유산소: 분당 8칼로리
               WHEN er.ex_id BETWEEN 11 AND 20 THEN er.duration * 6 -- 근력: 분당 6칼로리  
               ELSE er.duration * 5 -- 일상: 분당 5칼로리
           END as calories
    FROM exercise_record er 
    WHERE er.member_no = #{member_no}
    AND TO_CHAR(er.ex_date, 'YYYY-MM-DD') = #{exercise_date}
    ORDER BY er.record_id DESC
</select>
    
    <!-- 특정 회원의 운동 기록 개수 조회 -->
    <select id="getExerciseCount" parameterType="int" resultType="int">
        SELECT NVL(COUNT(*), 0) 
        FROM exercise_record 
        WHERE member_no = #{member_no}
    </select>
    
    <!-- 운동 기록 수정 -->
    <update id="updateData" parameterType="com.health.dto.ExerciseDTO">
        UPDATE exercise_record 
        SET ex_id = #{exercise_type_id}, 
            ex_date = TO_DATE(#{exercise_date}, 'YYYY-MM-DD'),
            duration = #{duration_minutes}
        WHERE record_id = #{exercise_record_id}
    </update>
    
    <!-- 운동 기록 삭제 -->
    <delete id="deleteData" parameterType="int">
        DELETE FROM exercise_record 
        WHERE record_id = #{exercise_record_id}
    </delete>
    
</mapper>